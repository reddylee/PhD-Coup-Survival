## Setup

```{r}
#| label: setup
library(tidyverse)
library(readxl)
library(haven)
library(data.table)
library(vdemdata)
library(democracyData)
library(janitor)
library(gtsummary)
library(zoo)
library(survival)
library(survminer)
library(kableExtra)
```


$$
Surv(\text{survival_time}, status) = group + 
GDP_\text{growth_trend} + GDP_\text{pc_log} + 
pop_{log} + polity5 + polstab + age$$

## overstays

```{r}
# coups <- fread("powell_thyne_coups_final.txt") %>% 
#   filter(coup==2) %>% 
#   mutate(startdate=ymd(paste(year,month,day)),
#          joindate=interval(startdate - days(1), startdate + days(1))
# ) %>% 
#   select(-c(3,4,9))

overstays <- read_excel("self_coup_Reddy.xlsx") %>% 
  filter(Success==1) %>% 
  select(ccode,ruler,starty,endy,overstay_year=year) 
```

## leaders

```{r}
leaders <- fread("Archigos.txt",encoding = "Latin-1") 

# update "still in office"
leaders$enddate[leaders$leader=="Nguema Mbasogo"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Rakhmonov"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Erdogan"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Afeworki"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Guelleh"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Paul Kagame"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Xi Jinping"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Museveni"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Nguesso"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Biya"] <- "2023-11-27"

leaders$endy[leaders$leader=="Nguema Mbasogo"] <- "2023-11-27"


leaders$enddate[leaders$leader=="Ilhma Aliyev"] <- "2023-11-27"


leaders$enddate[leaders$leader=="Lukashenko"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Putin"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Daniel Ortega"] <- "2023-11-27"

leaders$enddate[leaders$leader=="Faure Gnassingbe"] <- "2023-11-27"


## Update step down after 2015-12-31
leaders$enddate[leaders$leader=="Nazarbayev"] <- "2019-3-20"
leaders$exit[leaders$leader=="Nazarbayev"] <- "Regular"


leaders$enddate[leaders$leader=="Karimov"] <- "2016-9-2"
leaders$exit[leaders$leader=="Karimov"] <- "Regular"

leaders$enddate[leaders$leader=="Qabus Bin Said"] <- "2020-1-10"
leaders$exit[leaders$leader=="Qabus Bin Said"] <- "Regular"

leaders$enddate[leaders$leader=="Dos Santos"] <- "2017-9-25"
leaders$exit[leaders$leader=="Dos Santos"] <- "Regular"

leaders$enddate[leaders$leader=="Al-Bashir"] <- "2019-4-11"
leaders$exit[leaders$leader=="Al-Bashir"] <- "Irregular"

leaders$enddate[leaders$leader=="Bouteflika"] <- "2019-4-2"
leaders$exit[leaders$leader=="Bouteflika"] <- "Irregular"

leaders$enddate[leaders$leader=="Mugabe"] <- "2017-11-21"
leaders$exit[leaders$leader=="Mugabe"] <- "Irregular"

leaders$enddate[leaders$leader=="Nkurunziza"] <- "2022-6-8"
leaders$exit[leaders$leader=="Nkurunziza"] <- "Regular"

leaders$enddate[leaders$leader=="Joseph Kabila"] <- "2019-1-24"
leaders$exit[leaders$leader=="Joseph Kabila"] <- "Regular"



leaders$enddate[leaders$leader=="Deby"] <- "2021-4-20"
leaders$exit[leaders$leader=="Deby"] <- "Irregular"



leaders$enddate[leaders$leader=="Conde"] <- "2021-9-5"
leaders$exit[leaders$leader=="Conde"] <- "Irregular"

leaders$enddate[leaders$leader=="Jammeh"] <- "2011-1-19"
leaders$exit[leaders$leader=="Jammeh"] <- "Irregular"


leaders$enddate[leaders$leader=="Petro Poroshenko"] <- "2019-5-20"
leaders$exit[leaders$leader=="Petro Poroshenko"] <- "Regular"


leaders$enddate[leaders$leader=="Juan Morales"] <- "2019-11-10"
leaders$exit[leaders$leader=="Juan Morales"] <- "Irregular"

leaders$enddate[leaders$leader=="Medina"] <- "2020-8-16"
leaders$exit[leaders$leader=="Medina"] <- "Regular"

leaders$enddate[leaders$leader=="Hernández"] <- "2022-1-27"
leaders$exit[leaders$leader=="Hernández"] <- "Regular"


leaders$enddate[leaders$leader=="Rafael Correa"] <- "2017-5-24"
leaders$exit[leaders$leader=="Rafael Correa"] <- "Regular"


leaders$enddate[leaders$leader=="Prayuth Chan-ocha"] <- "2023-8-22"
leaders$exit[leaders$leader=="Prayuth Chan-ocha"] <- "Regular"

leaders$enddate[leaders$leader=="Hun Sen"] <- "2023-8-22"
leaders$exit[leaders$leader=="Hun Sen"] <- "Regular"

leaders1 <- leaders %>%
  mutate(syear=year(startdate),
         eyear=year(enddate)) %>% 
  filter(eyear > 1945) %>% 
  select(3:5,syear,eyear,6:10, yrborn)

leaders2 <- leaders1 %>% 
  mutate(coup_exit=ifelse(exitcode %in% c("Removed by Military, without Foreign Support","Removed by Other Government Actors, without Foreign Support"),1,0),
         tenure = ymd(enddate) - ymd(startdate)) %>% 
  mutate(coup_entry=ifelse(lag(coup_exit==1),1,0),.by = ccode)
```

## leaders + overstays
```{r}
mydata <- leaders2 %>% 
  left_join(overstays,by=c("ccode","syear"="starty","eyear"="endy")) %>% 
  filter(!(is.na(ruler)&coup_entry==0)) %>% 
  select(leader,ruler,everything()) %>%
  mutate(overstaydate = as.Date(paste(overstay_year, substr(startdate, 6, 10), sep = "-"))) 
```


```{r}
mydata1 <- mydata %>%
  mutate(
    group = case_when(!is.na(overstay_year) ~ "A",
                      .default = "B"),
    survival_time = case_when(
      group == "A" ~ ymd(enddate) - overstaydate,
      .default = ymd(enddate) - ymd(startdate)
    )
  ) %>%
  mutate(status = case_when(
    exit %in% c(
      "Regular",
      "Natural Death",
      "Still in Office",
      "Retired Due to Ill Health"
    ) ~ 1,
    .default = 2
  ))


table(mydata1$group)
table(mydata1$exit)
table(mydata1$status)
```

```{r}
mydata2 <- mydata1 |>
  mutate(
    startdate = if_else(group == "A", ymd(overstaydate), ymd(startdate)),
    enddate = ymd(enddate),
    age = if_else(group == "B", syear - yrborn, overstay_year -
                   yrborn)
  ) |>
  select(ccode, idacr, startdate, enddate, leader, age, group, survival_time, status) |>
  add_row(# add an observation for a new leader
    ccode = 552,
    idacr = "ZIM",
    startdate = ymd(20171124),
    enddate = ymd(20231127),
    leader = "Emmerson Mnangagwa",
    age = 75,
    group = "B",
    survival_time = enddate - startdate,
    status = 1
  )  |> 
  filter(survival_time > 180 & survival_time < 18000) 
```

## mydata2A
```{r}
mydata2A <- mydata2 |> 
  mutate(tstart = as.numeric(year(startdate) + (startdate - floor_date(startdate, "year"))/365),
         tstop = as.numeric(year(enddate) + (enddate - floor_date(enddate, "year"))/365),
         year = year(startdate),
         .after = enddate)
```

## mydata3
```{r}
mydata3A <- mydata2 |>
  mutate(first_year = startdate,
         last_year = enddate) |>
  survSplit(Surv(year(startdate), year(enddate), status) ~ .,
            data = _,
            cut = 1945:2022,
            id = "id",
            ) |>
  mutate(tstart = if_else(is.na(tstart), tstop, tstart)) |> 
  mutate(T1 = 0,
         T2 = ifelse(row_number() == 1, ceiling_date(first_year, "year") - first_year, 0),
         T2 = first(T2) + 365 * (row_number() - 1),
         T1 = lag(T2, default = 0),
         T2 = ifelse(row_number() == n(), survival_time, T2),
         .by = id) 
```

## GDP & population

```{r}
# codebook |> 
#   view()
gdp <- vdem |> 
  select(ccode = COWcode, country = country_name, year, GDP = e_gdp, GDP_pc = e_gdp, pop = e_pop) |>
  filter(year >= 1945)|> 
  mutate(GDP_growth = (GDP - lag(GDP)) / lag(GDP)*100,
         .by = ccode)

# create a new variable for 3-year moving average of GDP growth

GDP <- gdp |> 
  mutate(GDP_growth_3yr = rollmean(GDP_growth, k = 3, fill = NA, align = "right"),
         .by = ccode) |>
  mutate(GDP_growth_trend = GDP_growth / lag(GDP_growth_3yr),
         GDP_pc_log = log(GDP_pc),
         pop_log = log(pop)) |>
  select(ccode, country, year, GDP_growth_trend, GDP_pc_log, pop_log) |>
  drop_na() 
```

## Polity 5

```{r}
polity <- polity5 |> 
  select(ccode = polity_annual_ccode, year, polity) |>
  # if polity is less than -10, then replace it with its previous value
  mutate(polity5 = ifelse(polity < -10, NA, polity)) |>
  group_by(ccode) |>
  fill(polity5, .direction = "up") |>
  ungroup() |>
  filter(year >= 1945)
```

## Political Stability
```{r}
polstab <- read_excel("MEPVv2018.xls") |> 
  select(ccode, year, polstab= actotal)
```

## Merge data
```{r}
Mydata2A <- mydata2A |> 
  mutate(year = year(startdate)) |> 
  left_join(GDP, by = c("ccode", "year" = "year")) |> 
  left_join(polity, by = c("ccode", "year" = "year")) |>
  left_join(polstab, by = c("ccode", "year" = "year")) |>
  drop_na() |> 
  select(ccode, idacr, country, year, tstart, tstop, leader, age, group, survival_time, status, GDP_growth_trend, GDP_pc_log, pop_log, polity5, polstab)

Mydata2A |> 
  mutate(group = factor(group, 
                        labels = c("Overstay leaders", "Coup-entry leaders"))) |>
  coxph(Surv(survival_time, status) ~ group + GDP_growth_trend + GDP_pc_log + pop_log + polity5 + polstab + age, data = _) |>
  summary()
```

```{r}
Mydata3A <- mydata3A |>
  mutate(year = floor(tstart)) |>
  left_join(GDP, by = c("ccode", "tstart" = "year")) |>
  left_join(polity, by = c("ccode", "tstart" = "year")) |>
  left_join(polstab, by = c("ccode", "tstart" = "year")) |>
  drop_na() |>
  select(id, ccode, idacr, country, tstart, tstop, leader, age, group, survival_time, T1, T2, status, GDP_growth_trend, GDP_pc_log, pop_log, polity5, polstab)

Mydata3A |>
  mutate(group = factor(group, 
                        labels = c("Overstay leaders", "Coup-entry leaders"))) |>
coxph(Surv(T1, T2, status) ~ group + GDP_growth_trend + GDP_pc_log + pop_log + polity5 + polstab + age + cluster(id), data = _) |> 
  summary()
```

## Write to csv
```{r}
write.csv(Mydata2A, "mydata1.csv")
write.csv(Mydata3A, "mydata2.csv")
```

```{r}
export_summs(m1, m2)
```

